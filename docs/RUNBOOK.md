# RUNBOOK.md

## 1. 目的

この文書は実行ルールである。  
一度読んだら常に従う。

## 2. 不変ルール

1. 返信対象は `ALLOWED_CHANNEL_IDS` に含まれるチャンネルのみ。
2. 指定チャンネル内の投稿（メンション有無を問わない）を AI 処理対象とする。
3. `mentionedBot` は AI 入力へ含めるが、ハンドラで優先制御しない。
4. スレッドと DM は現時点で非対応。
5. 会話ログ本文は永続保存しない。
6. AI 入力には現在メッセージに加えて直近 10 件を含める。
7. 追加履歴は `read_message_history` で都度取得できる。
8. AI は必要時に `start_typing` で入力中表示を開始でき、Discord turn 完了時に自動停止される。
9. Bot 直接メンション時の自動 typing 送信も継続する。
10. ワークスペース（`$LUNA_HOME/workspace`）のドキュメントを AI instructions に読み込む。
11. 自己改善ドキュメントの自動更新フローは現時点で未実装。
12. 秘密情報をログやドキュメントに平文出力しない。
13. `STATUS.md` は作業ごとに AI が更新する。
14. heartbeat は毎時 00 分 / 30 分（JST）に自動実行する。
15. heartbeat 実行時は以下の固定プロンプトを使う。  
    `HEARTBEAT.md`がワークスペース内に存在する場合はそれを確認し、内容に従って作業を行ってください。過去のチャットで言及された古いタスクを推測したり繰り返してはいけません。特に対応すべき事項がない場合は、そのまま終了してください。

## 3. 実行手順

### 3.1 起動前チェック

1. `DISCORD_BOT_TOKEN` が設定されていることを確認する。
2. `ALLOWED_CHANNEL_IDS` が 1 件以上設定されていることを確認する。
3. `LUNA_HOME` 未設定時は `~/.luna` を使用することを確認する。
4. 起動時に `LUNA_HOME` / `$LUNA_HOME/workspace` / `$LUNA_HOME/codex` が自動作成されることを確認する。

### 3.2 開発時コマンド

1. `pnpm run dev`
2. `pnpm run typecheck`
3. `pnpm run lint`
4. `pnpm run format:check`
5. `pnpm run build`

### 3.3 運用時の基本挙動

1. 受信イベントでチャンネル判定（DM/スレッド/許可外除外）を実施する。
2. 現在メッセージと直近 10 件を AI に渡す。
3. AI は必要時に `read_message_history` / `send_message` / `add_reaction` / `start_typing` を使用する。
4. AI エラー時は返信せず終了し、失敗ログを確認する。
5. heartbeat 実行が失敗してもプロセスは継続し、次の cron 周期で再実行する。

## 4. プロンプト運用

AI には最低限以下を渡す。

1. ルナの人格定義とセーフティガード
2. 現在メッセージ（author/channel/message）
3. 直近メッセージ履歴
4. 返信・リアクション時は `discord` ツールを使う制約

## 5. 失敗時対応

1. Discord 投稿失敗:
   - 失敗をログ化する。
2. AI 呼び出し失敗:
   - 返信せず終了する。
   - 失敗理由をログで確認する。
3. 設定不備:
   - 起動を中断する。

## 6. 変更管理

1. 仕様変更は `SPEC.md` に反映する。
2. 実装方針変更は `PLAN.md` と `ARCHITECTURE.md` に反映する。
3. 運用ルール変更は `RUNBOOK.md` に反映する。
4. 進捗・現況は `STATUS.md` に反映する。

## 7. セキュリティ運用

1. トークン値はマスクする。
2. 会話内容を外部へ二次利用しない。
3. 不要なログを残さない。
