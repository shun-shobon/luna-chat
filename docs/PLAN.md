# PLAN.md

## 1. 方針

- 小さく作って早く動かす。
- ログ永続化や外部 DB は導入しない。
- 複雑な最適化より、会話体験と運用しやすさを優先する。
- 自己改善はドキュメントに限定し、コードは人間が変更する。

## 2. マイルストーン

### M1: 会話の基本動作

成果物:

- 指定チャンネルフィルタ
- メンション必須返信
- 通常投稿の AI 判定返信
- `!ping` 依存の撤廃

完了条件:

- 指定外チャンネルで無反応
- メンション時に 100% 返信

### M2: 文脈付き会話

成果物:

- AI 呼び出しごとの Discord 履歴取得
- 追加履歴の tool use ループ（無制限）
- 会話プロンプトの統一テンプレート

完了条件:

- 履歴永続化なしで文脈会話が成立
- AI が追加履歴要求を実行可能

### M3: 自己改善ドキュメント運用

成果物:

- Codex 用ワークスペースの分離
- 改善対象ドキュメント群（人格、運用、謝罪定型文）
- AI による作業ごとのドキュメント更新フロー

完了条件:

- Luna Chat 本体コードを変更せずに、ドキュメント更新が回る

### M4: 品質強化

成果物:

- ユニットテスト
- 結合テスト（Discord API 依存をモック）
- E2E 以外の可能な範囲で自動テスト整備

完了条件:

- `typecheck` `lint` `format:check` `test` `build` が通る

## 3. リスクレジスタ

| ID  | リスク                             | 影響             | 対策                                                     |
| --- | ---------------------------------- | ---------------- | -------------------------------------------------------- |
| R1  | AI が返信しすぎる / しなさすぎる   | 会話体験の悪化   | プロンプトに返信方針を明文化し、調整用ドキュメントを分離 |
| R2  | 履歴追加取得の無制限運用で遅延増大 | 返信遅延         | 取得回数と件数をログ計測し、必要時に運用で制限追加       |
| R3  | ログ非永続のため長期文脈が弱い     | 一貫性低下       | 人格・長期メモをドキュメントで補完                       |
| R4  | 自己改善が意図とずれる             | 運用ノイズ       | 更新対象を Codex ワークスペースのドキュメントに限定      |
| R5  | 秘密情報漏えい                     | セキュリティ事故 | トークンをログ出力しない、ドキュメントに平文記載しない   |
| R6  | Discord 仕様変更や API エラー      | 不安定化         | 失敗時は謝罪定型文へフォールバック                       |

## 4. アーキテクチャ概要

- Discord 受信
- チャンネル / メンション判定
- 文脈取得（都度 Discord から）
- Codex CLI app-server 推論 / tool use
- 返信送信
- 自己改善ドキュメント更新（別ワークスペース）

## 5. 完了定義（DoD）

- `SPEC.md` の受け入れ条件を満たす。
- コード変更はレビュー可能な最小差分である。
- ドキュメントが現在の挙動と矛盾しない。
- `STATUS.md` が作業ごとに更新されている。
