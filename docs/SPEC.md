# SPEC.md

## 1. 目的

luna-chat は、身内向け Discord サーバーで雑談に自然参加する Bot を作るプロジェクトである。  
人格名は「ルナ」とし、優しい少女の雰囲気で会話する。口調は敬語とため口を混在させる。

## 2. 対象ユーザー

- 開発者本人
- 開発者の身内コミュニティ

多少の粗さや不完全さは許容する。

## 3. プロダクト要件（MVP）

### 3.1 会話参加

- 指定されたチャンネルでのみ動作する。
- Bot へのメンションがある投稿は優先して返信を試みる。
- メンションがない投稿への返信可否は AI が判断する。
- すべての投稿へ返信する必要はない。
- Discord 投稿起点に加えて heartbeat 起点でも AI を実行する。
- heartbeat は毎時 00 分 / 30 分（JST）に自動実行する。
- heartbeat 実行時のプロンプトは「HEARTBEAT.mdを確認し、作業を行ってください。」を固定で使う。
- AI は必要に応じて tool use（`add_reaction`）でメッセージにリアクションを付与してよい。
- 返信時は必ず `send_message` を使い、`add_reaction` のみで返信を代替しない。

### 3.2 文脈取得

- メッセージログを永続保存しない。
- AI 呼び出し時は現在メッセージを渡し、必要な過去履歴は AI が tool use（`read_message_history`）で都度取得する。
- AI が「さらに過去を見たい」と判断した場合、tool use 経由で追加取得を無制限に実行できる。

### 3.3 推論と制御

- 推論、tool use、ワークフロー制御は Codex CLI app-server を中心に実行する。
- 現時点で外部サービス連携は必須にしない（Codex CLI 既定機能の利用は可）。

### 3.4 自己改善

- 自己改善はドキュメント更新のみ許可する。
- コード改変は自己改善対象外とする。
- luna-chat 本体コードのディレクトリとは別に、Codex CLI 用ワークスペースディレクトリを持つ。
- 改善対象ドキュメント（人格設定、運用メモ、定型文など）は Codex CLI 用ワークスペースに配置する。

### 3.5 エラー応答

- AI 呼び出し失敗時は、返信せず処理を終了する。
- 失敗内容はログに記録する。

### 3.6 コマンド

- `!ping` のようなテスト用コマンドは MVP 必須機能ではない（最終的に不要）。

## 4. 非機能要件

- 初期の正規実行環境はローカル常駐とする。
- VPS / コンテナは将来の実行形態として許容する。
- 明示的な性能 SLA は当面設けない。
- セキュリティの最低要件として、秘密情報（トークンなど）はドキュメントやログに平文出力しない。

## 5. 設定要件

- 複数チャンネル ID を設定可能にする。
- 例: `ALLOWED_CHANNEL_IDS=1234567890,2345678901`

## 6. 受け入れ条件

1. 指定外チャンネルでは返信しない。
2. 指定チャンネル内で、メンション投稿は優先的に返信を試みる。
3. 通常投稿への返信は AI 判断で行われる。
4. 履歴永続化なしで、必要時に tool use で Discord から都度文脈取得できる。
5. 追加履歴取得を tool use で実行できる。
6. AI 失敗時は返信せず終了し、失敗ログを確認できる。
7. 自己改善で更新されるのは Codex ワークスペース内ドキュメントのみで、luna-chat 本体コードは更新しない。
8. リアクション付与は `add_reaction` で実行できるが、メンション返信の成立条件は `send_message` 実行である。
9. heartbeat は毎時 00 分 / 30 分（JST）に実行される。
10. heartbeat 実行時は固定プロンプト「HEARTBEAT.mdを確認し、作業を行ってください。」が渡される。
